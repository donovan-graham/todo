<html>
  <head>
    <title>BOB</title>
    <favicon href="favicon.ico" />

    <link rel="icon" type="image/x-icon" href="/static/favicon.ico" />
  </head>
  <body>
    <h1>Hello Bob</h1>

    <div>State: <span id="status">Connecting...</span></div>

    <button id="offlineBtn">Offline</button>
    <button id="onlineBtn">On-line</button>

    <button id="send">Send</button>
  </body>

  <!-- <script src="/socket.io/socket.io.js"></script> -->
  <script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>

  <script>
    const statusElm = document.getElementById("status");

    const realToken =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjoiRG9uIiwiaWF0IjoxNzM3ODE3NTcwLCJleHAiOjE3Mzc4MjExNzB9.JT5p4dLfphFlFdQ6uSB80M8TnbeaMELMZ3uMsvmIzKY";

    const altToken =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjoiZm9vIiwiaWF0IjoxNzM3ODE0NjE5LCJleHAiOjE3Mzc4MTgyMTl9.vZRg3K7ygB3Jnc_qGKHL81_kRxlIni2tNlsakMatOZ0";
    let token = realToken;
    const socket = io("ws://localhost:3000", {
      namespace: "/chat",
      transports: ["websocket"],
      auth: {
        token: "123",
      },
    });

    socket.on("ping", () => {
      console.log("Socket.io = Ping received from server");
    });

    socket.on("connect", () => {
      statusElm.innerHTML = "Connected";
      console.log("Socket.io = Connected to server");

      socket.emit("chat", "Hello, Server!");
    });

    socket.on("connect_error", (error) => {
      statusElm.innerHTML = "Error";
      console.log(`Socket.io = Error connecting to server: ${error}`);
    });

    socket.on("reconnect", (attempt) => {
      statusElm.innerHTML = "Reconnecting ...";

      console.log(
        `Socket.io = Reconnected to server after ${attempt} attempts`
      );
    });

    socket.on("disconnect", (reason) => {
      if (socket.active) {
        statusElm.innerHTML = "Temporary disconnection";
        console.log("Socket.io = Temporary disconnection");
        // temporary disconnection, the socket will automatically try to reconnect
      } else {
        statusElm.innerHTML = "Permanent disconnection";

        console.log(`Socket.io = Permanent disconnection ${reason}`);
      }
    });

    socket.on("message", (error) => {
      console.log(`Socket.io = Error: ${error.message}`);
    });

    socket.on("error", (error) => {
      console.log(`Socket.io = Error: ${error.message}`);
    });

    socket.on("chat", (msg) => {
      console.log(`Socket.io = Chat message from server: ${msg}`);
    });

    document.getElementById("offlineBtn").addEventListener("click", () => {
      statusElm.innerHTML = "Disconnected";
      socket.active = false;
      socket.disconnect();
    });

    function randomIntFromInterval(min, max) {
      // min and max included
      return Math.floor(Math.random() * (max - min + 1) + min);
    }

    document.getElementById("onlineBtn").addEventListener("click", () => {
      statusElm.innerHTML = "Connecting ...";
      console.log(`Socket.io = attempting connect`);

      socket.auth.token =
        randomIntFromInterval(0, 1) === 1 ? realToken : altToken;
      socket.active = true;
      socket.connect();
    });

    document.getElementById("send").addEventListener("click", () => {
      socket.emit("chat", new Date().toISOString());
    });

    // https://socket.io/docs/v4/client-options/#auth
    // https://socket.io/docs/v4/client-api/#iourl
  </script>

  <!-- <script>
    var ws = new WebSocket("ws://localhost:3030");

    ws.onopen = () => {
      console.log("Connected to server");
      ws.send("Hello, Server!");
    };

    ws.onmessage = (event) => {
      console.log(`Message from server: ${event.data}`);
    };

    ws.onclose = () => {
      console.log("Connection closed");
    };
  </script> -->
</html>
